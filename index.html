<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Nahl â€¢ Bookings & Reviews Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#F5F7F8;          /* Nahl background */
      --surface:#FFFFFF;     /* Main cards */
      --surface-alt:#FBFCFD; /* Soft alt surface */
      --border:#E1E4E8;
      --text:#45474B;        /* Nahl primary text */
      --muted:#6B7280;
      --accent:#F4CE14;      /* Nahl yellow */
      --accent-soft:#FFF7CC;
      --accent-dark:#D9AE00;
      --danger:#EF4444;
      --radius-lg:16px;
      --radius-md:12px;
      --shadow-soft:0 10px 30px rgba(15,23,42,0.10);
      --chart-height:280px;
      --transition-fast:180ms ease-out;
    }

    /* Dark theme overrides (Nahl dark mode) */
    [data-theme="dark"]{
      --bg:#020617;
      --surface:#020617;
      --surface-alt:#020617;
      --border:#1F2937;
      --text:#E5E7EB;
      --muted:#9CA3AF;
      --accent:#F4CE14;
      --accent-soft:#3B2F0B;
      --accent-dark:#E5B800;
      --shadow-soft:0 18px 45px rgba(0,0,0,0.85);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    body{min-height:100vh;}

    .app-shell{
      max-width:1200px;
      margin:0 auto;
      padding:16px 16px 48px;
    }

    /* Animations */
    .anim-section{
      opacity:0;
      transform:translateY(12px);
      transition:
        opacity 260ms ease-out,
        transform 260ms ease-out,
        box-shadow var(--transition-fast),
        transform var(--transition-fast);
    }
    .anim-section.is-visible{
      opacity:1;
      transform:translateY(0);
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
      padding:8px 4px;
    }
    @media (max-width:720px){
      header.app-header{
        flex-direction:column;
        align-items:flex-start;
      }
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-badge{
      width:42px;
      height:42px;
      border-radius:14px;
      display:grid;
      place-items:center;
      background:linear-gradient(135deg,#F4CE14,#FACC2E);
      color:#111827;
      font-weight:800;
      box-shadow:0 4px 18px rgba(148,120,4,0.35);
      font-size:20px;
    }
    .brand-text-title{
      font-weight:800;
      font-size:21px;
      letter-spacing:0.02em;
      color:var(--text);
    }
    .brand-text-sub{
      font-size:12px;
      color:var(--muted);
    }

    .right-header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
    }
    @media (max-width:720px){
      .right-header{
        width:100%;
        justify-content:space-between;
      }
    }

    .badge-soft{
      background:var(--accent-soft);
      color:#8B5A00;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    [data-theme="dark"] .badge-soft{
      color:#FACC2E;
    }

    .filters-bar{
      background:var(--surface);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:12px 16px 10px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      margin-bottom:18px;
      border:1px solid var(--border);
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:140px;
      flex:1 1 140px;
    }
    .filter-label{
      font-size:11px;
      color:var(--muted);
    }
    .filter-input,
    .filter-select{
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:13px;
      background:var(--surface-alt);
      color:var(--text);
      min-height:34px;
      transition:border-color var(--transition-fast), box-shadow var(--transition-fast), background-color var(--transition-fast);
    }
    .filter-input:focus,
    .filter-select:focus{
      outline:none;
      box-shadow:0 0 0 1px rgba(244,206,20,0.65);
      border-color:var(--accent);
      background:#FFFFFF;
    }

    .filter-quick-range{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:160px;
      flex:1 1 160px;
    }
    .chip-group{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:11px;
      background:var(--surface-alt);
      color:var(--muted);
      cursor:pointer;
      transition:
        background-color var(--transition-fast),
        color var(--transition-fast),
        border-color var(--transition-fast),
        transform var(--transition-fast);
    }
    .chip:hover{
      transform:translateY(-1px);
      background:#FFFFFF;
    }
    .chip.is-active{
      border-color:var(--accent-dark);
      background:var(--accent-soft);
      color:#8B5A00;
    }
    [data-theme="dark"] .chip.is-active{
      color:#FACC2E;
    }

    .filters-actions{
      display:flex;
      gap:8px;
      margin-inline-start:auto;
      align-items:flex-end;
    }
    @media (max-width:720px){
      .filters-actions{
        width:100%;
        justify-content:flex-start;
        margin-inline_start:0;
      }
    }

    .btn{
      border-radius:10px;
      border:1px solid transparent;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:transparent;
      color:var(--text);
      transition:
        background-color var(--transition-fast),
        border-color var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }
    .btn-primary{
      background:var(--accent);
      color:#111827;
      border-color:transparent;
      box-shadow:0 4px 16px rgba(148,120,4,0.35);
    }
    .btn-primary:hover{
      background:#FACC2E;
      transform:translateY(-1px);
    }
    .btn-ghost{
      border-color:var(--border);
      color:var(--muted);
      background:var(--surface);
    }
    .btn-ghost:hover{
      background:var(--surface-alt);
      transform:translateY(-1px);
    }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    @media (max-width:900px){
      .kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width:600px){
      .kpi-grid{grid-template-columns:repeat(1,minmax(0,1fr));}
    }
    .kpi-card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      padding:12px 14px 10px;
      border:1px solid var(--border);
      box-shadow:0 4px 16px rgba(15,23,42,0.10);
      transition:box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
    }
    .kpi-card:hover{
      transform:translateY(-2px);
      border-color:rgba(244,206,20,0.9);
      box-shadow:0 10px 26px rgba(15,23,42,0.18);
    }
    .kpi-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }
    .kpi-value{
      font-size:20px;
      font-weight:700;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .grid-2{
      display:grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1.6fr);
      gap:12px;
      margin-bottom:16px;
    }
    @media (max-width:900px){
      .grid-2{grid-template-columns:1fr;}
    }
    .card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      padding:10px 12px 14px;
      transition:box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
    }
    .card:hover{
      transform:translateY(-2px);
      border-color:rgba(244,206,20,0.7);
      box-shadow:0 14px 30px rgba(15,23,42,0.20);
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .card-title{
      font-size:13px;
      font-weight:700;
      color:var(--text);
    }
    .card-sub{
      font-size:11px;
      color:var(--muted);
    }

    canvas{
      width:100% !important;
      height:var(--chart-height) !important;
    }

    .subscores{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }
    @media (max-width:700px){
      .subscores{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .subscore-item{
      background:var(--surface-alt);
      border-radius:var(--radius-md);
      padding:6px 8px;
      border:1px solid var(--border);
    }
    .subscore-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .subscore-value{
      font-size:13px;
      font-weight:600;
      color:var(--text);
    }
    .subscore-bar-wrap{
      margin-top:4px;
      width:100%;
      height:5px;
      background:#E5E7EB;
      border-radius:999px;
      overflow:hidden;
    }
    [data-theme="dark"] .subscore-bar-wrap{
      background:#111827;
    }
    .subscore-bar{
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent-dark));
      width:0%;
      transition:width .25s ease-out;
    }

    .table-wrap{
      max-height:260px;
      overflow:auto;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:var(--surface-alt);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead{
      background:var(--surface-alt);
      position:sticky;
      top:0;
      z-index:1;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid var(--border);
      text-align:start;
      white-space:nowrap;
    }
    th{
      font-weight:600;
      color:var(--muted);
    }
    tbody tr:hover{
      background:var(--surface);
    }

    .lists-grid{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1.2fr);
      gap:12px;
      margin-top:8px;
    }
    @media (max-width:900px){
      .lists-grid{grid-template-columns:1fr;}
    }

    .list{
      max-height:260px;
      overflow:auto;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:var(--surface-alt);
      padding:6px 8px;
    }
    .list-item{
      padding:6px 4px;
      border-bottom:1px solid var(--border);
      font-size:12px;
    }
    .list-item:last-child{border-bottom:none;}
    .list-title{
      font-weight:600;
      margin-bottom:2px;
      color:var(--text);
    }
    .list-meta{
      color:var(--muted);
      font-size:11px;
    }
    .list-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      background:var(--accent-soft);
      font-size:10px;
      color:#8B5A00;
      margin-inline-end:4px;
    }
    [data-theme="dark"] .list-pill{
      color:#FACC2E;
    }

    .status-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:14px;
      font-size:11px;
      color:var(--muted);
      gap:8px;
      padding:8px 4px 0;
      border-top:1px dashed var(--border);
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22C55E;
      margin-inline-start:4px;
    }

    .skeleton{
      background:linear-gradient(90deg,#F3F4F6,#E5E7EB,#F3F4F6);
      background-size:200% 100%;
      animation:skeleton 1.2s ease-in-out infinite;
    }
    [data-theme="dark"] .skeleton{
      background:linear-gradient(90deg,#111827,#1F2937,#111827);
    }
    @keyframes skeleton{
      0%{background-position:200% 0;}
      100%{background-position:-200% 0;}
    }

    /* Mobile: convert tables into card-style records */
    @media (max-width: 640px){
      .table-wrap {
        max-height:none;
        overflow:visible;
        border:none;
        background:transparent;
      }

      .table-wrap table,
      .table-wrap thead,
      .table-wrap tbody,
      .table-wrap th,
      .table-wrap td,
      .table-wrap tr {
        display:block;
        width:100%;
      }

      .table-wrap thead {
        position:absolute;
        height:1px;
        width:1px;
        overflow:hidden;
        clip: rect(1px,1px,1px,1px);
        white-space:nowrap;
      }

      .table-wrap tbody tr {
        margin-bottom:10px;
        border-radius:var(--radius-lg);
        border:1px solid var(--border);
        background:var(--surface);
        box-shadow:0 4px 10px rgba(15,23,42,0.08);
        padding:6px 8px;
      }

      .table-wrap td {
        border:none;
        border-bottom:1px solid rgba(226,232,240,0.7);
        position:relative;
        padding:6px 8px;
        padding-right:32%;
        white-space:normal;
      }

      .table-wrap td:last-child {
        border-bottom:none;
      }

      .table-wrap td::before {
        content:attr(data-label);
        position:absolute;
        top:6px;
        right:8px;
        font-size:11px;
        font-weight:600;
        color:var(--muted);
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header anim-section">
      <div class="brand">
        <div class="brand-badge">N</div>
        <div>
          <div class="brand-text-title">Nahl Dashboard</div>
          <div class="brand-text-sub">Ù„ÙˆØ­Ø© Ø­Ø¬ÙˆØ²Ø§Øª ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø§Øª Ø¨Ø³ÙŠØ·Ø© â€¢ Nahl Bookings & Reviews</div>
        </div>
      </div>
      <div class="right-header">
        <span class="badge-soft">ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</span>
        <button id="btnTheme" class="btn btn-ghost" type="button" aria-label="ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶">ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†</button>
        <button id="btnRefresh" class="btn btn-ghost" type="button">âŸ³ ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </header>

    <!-- Filters -->
    <section class="filters-bar anim-section" aria-label="ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
      <div class="filter-group">
        <label class="filter-label" for="dateFrom">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input id="dateFrom" type="date" class="filter-input" />
      </div>
      <div class="filter-group">
        <label class="filter-label" for="dateTo">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input id="dateTo" type="date" class="filter-input" />
      </div>
      <div class="filter-group">
        <label class="filter-label" for="filterLocation">Ø§Ù„ÙØ±Ø¹ / Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
        <select id="filterLocation" class="filter-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label" for="filterService">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <select id="filterService" class="filter-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label" for="filterLocale">Ø§Ù„Ù„ØºØ© / Locale</label>
        <select id="filterLocale" class="filter-select">
          <option value="">Ø§Ù„ÙƒÙ„</option>
        </select>
      </div>

      <!-- Quick range chips -->
      <div class="filter-quick-range">
        <label class="filter-label">Ù†Ø·Ø§Ù‚ Ø³Ø±ÙŠØ¹</label>
        <div class="chip-group" id="quickRanges">
          <button type="button" class="chip" data-range="7">Ø¢Ø®Ø± Ù§ Ø£ÙŠØ§Ù…</button>
          <button type="button" class="chip is-active" data-range="30">Ø¢Ø®Ø± Ù£Ù  ÙŠÙˆÙ…</button>
          <button type="button" class="chip" data-range="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
        </div>
      </div>

      <div class="filters-actions">
        <button id="btnApply" class="btn btn-primary" type="button">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        <button id="btnClear" class="btn btn-ghost" type="button">Ù…Ø³Ø­</button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="kpi-grid anim-section" id="kpiGrid" aria-label="Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
      <div class="kpi-card">
        <div class="kpi-label">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>
          <span class="status-dot"></span>
        </div>
        <div class="kpi-value" id="kpiBookings">â€”</div>
        <div class="kpi-sub" id="kpiReviewRate">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: â€”%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</span>
          <span id="currencyLabel">SAR</span>
        </div>
        <div class="kpi-value" id="kpiRevenue">â€”</div>
        <div class="kpi-sub" id="kpiAvgTicket">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ°ÙƒØ±Ø©: â€”</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</span>
          <span>â­</span>
        </div>
        <div class="kpi-value" id="kpiRating">â€”</div>
        <div class="kpi-sub" id="kpiNps">NPS: â€”</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">
          <span>Ù…ØªÙˆØ³Ø· Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span>
          <span>ğŸ§º</span>
        </div>
        <div class="kpi-value" id="kpiServicesPerBooking">â€”</div>
        <div class="kpi-sub">Ù„ÙƒÙ„ Ø­Ø¬Ø²</div>
      </div>
    </section>

    <!-- Charts Row -->
    <section class="grid-2 anim-section" aria-label="Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø²Ù…Ù†ÙŠ)</div>
            <div class="card-sub">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          </div>
        </div>
        <canvas id="tsChart" aria-label="Time series chart"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
            <div class="card-sub">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„ÙƒÙ„ Ù†Ø¬Ù…Ø©</div>
          </div>
        </div>
        <canvas id="ratingChart" aria-label="Rating distribution chart"></canvas>
        <div class="subscores" style="margin-top:10px;">
          <div class="subscore-item">
            <div class="subscore-label">Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ</div>
            <div class="subscore-value" id="subQuality">â€”</div>
            <div class="subscore-bar-wrap"><div id="barQuality" class="subscore-bar"></div></div>
          </div>
          <div class="subscore-item">
            <div class="subscore-label">Ø³Ø±Ø¹Ø© Ø§Ù„Ø®Ø¯Ù…Ø©</div>
            <div class="subscore-value" id="subSpeed">â€”</div>
            <div class="subscore-bar-wrap"><div id="barSpeed" class="subscore-bar"></div></div>
          </div>
          <div class="subscore-item">
            <div class="subscore-label">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            <div class="subscore-value" id="subStaff">â€”</div>
            <div class="subscore-bar-wrap"><div id="barStaff" class="subscore-bar"></div></div>
          </div>
          <div class="subscore-item">
            <div class="subscore-label">Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø³Ø¹Ø±</div>
            <div class="subscore-value" id="subValue">â€”</div>
            <div class="subscore-bar-wrap"><div id="barValue" class="subscore-bar"></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tables Row -->
    <section class="grid-2 anim-section" aria-label="Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
            <div class="card-sub">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ù„ÙƒÙ„ ÙØ±Ø¹</div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                <th>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</th>
                <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th>
              </tr>
            </thead>
            <tbody id="tblLocationBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø£ÙØ¶Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
            <div class="card-sub">Ø£Ø¹Ù„Ù‰ Ù¡Ù  Ø®Ø¯Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</div>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</th>
                <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th>
              </tr>
            </thead>
            <tbody id="tblServicesBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Lists -->
    <section class="lists-grid anim-section" aria-label="Ø£Ø­Ø¯Ø« Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø¢Ø®Ø± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
            <div class="card-sub">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ø£Ø­Ø¯Ø« Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
          </div>
        </div>
        <div class="list" id="listBookings"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ø¢Ø®Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</div>
            <div class="card-sub">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ø£Ø­Ø¯Ø« Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
          </div>
        </div>
        <div class="list" id="listReviews"></div>
      </div>
    </section>

    <div class="status-bar anim-section" id="statusBar">
      <div>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="statusLeft">Ø¬Ø§Ù‡Ø²</span></div>
      <div id="statusRight">â€”</div>
    </div>
  </div>

  <script>
    let tsChart = null;
    let ratingChart = null;
    let isLoading = false;
    let currentTheme = 'light';
    let lastUpdated = null;

    function setStatus(msg){
      const el = document.getElementById('statusRight');
      if (el) el.textContent = msg || 'â€”';
    }

    function setStatusLeft(msg){
      const el = document.getElementById('statusLeft');
      if (el) el.textContent = msg || 'Ø¬Ø§Ù‡Ø²';
    }

    function updateLastUpdated(){
      lastUpdated = new Date();
      const el = document.getElementById('statusRight');
      if (!el) return;
      const timeStr = lastUpdated.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
      el.textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + timeStr;
    }

    function setLoading(loading){
      isLoading = loading;
      const btnApply = document.getElementById('btnApply');
      const btnRefresh = document.getElementById('btnRefresh');
      if (btnApply) btnApply.disabled = loading;
      if (btnRefresh) btnRefresh.disabled = loading;

      if (loading){
        setStatusLeft('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦');
        setStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©');
      }else{
        setStatusLeft('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        updateLastUpdated();
      }
    }

    function formatNumber(value){
      const v = Number(value)||0;
      return v.toLocaleString('en-US',{maximumFractionDigits:2});
    }

    function formatDateInput(d){
      return d.toISOString().slice(0,10);
    }

    function setDefaultDates(){
      const to = new Date();
      const from = new Date();
      from.setDate(from.getDate() - 30);
      document.getElementById('dateFrom').value = formatDateInput(from);
      document.getElementById('dateTo').value   = formatDateInput(to);
    }

    function setQuickRange(range){
      const to = new Date();
      const from = new Date();

      if (range === 'month'){
        from.setDate(1); // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      }else{
        const days = Number(range) || 7;
        from.setDate(from.getDate() - days);
      }

      document.getElementById('dateFrom').value = formatDateInput(from);
      document.getElementById('dateTo').value   = formatDateInput(to);
    }

    /* ========== THEME HANDLING ========== */
    function applyTheme(theme){
      currentTheme = theme === 'dark' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      localStorage.setItem('nahl_dashboard_theme', currentTheme);

      const btnTheme = document.getElementById('btnTheme');
      if (btnTheme){
        if (currentTheme === 'dark'){
          btnTheme.textContent = 'â˜€ï¸ ÙˆØ¶Ø¹ ÙØ§ØªØ­';
        }else{
          btnTheme.textContent = 'ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†';
        }
      }

      if (typeof Chart !== 'undefined'){
        const cs = getComputedStyle(document.documentElement);
        const textColor = cs.getPropertyValue('--muted') || '#6b7280';
        const gridColor = cs.getPropertyValue('--border') || '#e5e7eb';
        Chart.defaults.color = textColor.trim();
        Chart.defaults.borderColor = gridColor.trim();
        if (tsChart) tsChart.update();
        if (ratingChart) ratingChart.update();
      }
    }

    function initTheme(){
      const stored = localStorage.getItem('nahl_dashboard_theme');
      if (stored === 'dark' || stored === 'light'){
        applyTheme(stored);
      }else{
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }
    }

    /* ========== FILTERS / DATA ========== */
    function loadFilters(){
      if (typeof google === 'undefined' || !google.script || !google.script.run) return;
      google.script.run
        .withSuccessHandler(data => {
          const locSel  = document.getElementById('filterLocation');
          const srvSel  = document.getElementById('filterService');
          const loclSel = document.getElementById('filterLocale');

          const fillSelect = (sel, items) => {
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
            (items || []).forEach(v => {
              const opt = document.createElement('option');
              opt.value = v;
              opt.textContent = v;
              sel.appendChild(opt);
            });
            if (current) sel.value = current;
          };

          fillSelect(locSel,  data.locations || []);
          fillSelect(srvSel,  data.servicesAR || []);
          fillSelect(loclSel, data.locales || []);
        })
        .getFilters();
    }

    function getCurrentFilters(){
      const dateFrom = document.getElementById('dateFrom').value || '';
      const dateTo   = document.getElementById('dateTo').value || '';
      const location = document.getElementById('filterLocation').value || '';
      const serviceAR= document.getElementById('filterService').value || '';
      const locale   = document.getElementById('filterLocale').value || '';
      return { dateFromISO:dateFrom, dateToISO:dateTo, location, serviceAR, locale };
    }

    function loadDashboard(){
      if (typeof google === 'undefined' || !google.script || !google.script.run) return;
      const filters = getCurrentFilters();
      setLoading(true);
      google.script.run
        .withSuccessHandler(onDashboardDataLoaded)
        .withFailureHandler(err => {
          console.error(err);
          setStatus('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
          setStatusLeft('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
          setLoading(false);
        })
        .getDashboardData(filters);
    }

    function onDashboardDataLoaded(data){
      try{
        if (!data){
          setStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©');
          return;
        }

        // KPIs
        document.getElementById('kpiBookings').textContent = formatNumber(data.kpis.totalBookings);
        document.getElementById('kpiRevenue').textContent  = formatNumber(data.kpis.totalRevenue);
        document.getElementById('kpiAvgTicket').textContent = 'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ°ÙƒØ±Ø©: ' + formatNumber(data.kpis.avgTicket);
        document.getElementById('kpiServicesPerBooking').textContent = formatNumber(data.kpis.avgServicesPerBooking);
        document.getElementById('kpiRating').textContent   = data.kpis.avgRating ? data.kpis.avgRating.toFixed(2) : 'â€”';
        document.getElementById('kpiNps').textContent      = 'NPS: ' + (data.kpis.npsScore || 0) + '%';
        document.getElementById('kpiReviewRate').textContent = 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + (data.kpis.reviewRate || 0).toFixed(1) + '%';
        document.getElementById('currencyLabel').textContent = data.currency || 'SAR';

        // Subscores
        const subs = data.subscores || {};
        const maxSub = 5;
        const setSub = (idVal, idBar, value) => {
          const v = Number(value)||0;
          const elVal = document.getElementById(idVal);
          const elBar = document.getElementById(idBar);
          if (elVal) elVal.textContent = v ? v.toFixed(2) : 'â€”';
          if (elBar) elBar.style.width = (Math.min(v,maxSub)/maxSub*100) + '%';
        };
        setSub('subQuality','barQuality',subs.quality);
        setSub('subSpeed','barSpeed',subs.speed);
        setSub('subStaff','barStaff',subs.staff);
        setSub('subValue','barValue',subs.value);

        // Charts
        renderTsChart(data.series || []);
        renderRatingChart(data.ratingDistribution || [0,0,0,0,0]);

        // Tables
        renderLocationTable(data.byLocation || []);
        renderServicesTable(data.topServices || []);

        // Lists
        renderBookingsList(data.bookingsList || []);
        renderReviewsList(data.reviewsList || []);

        setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      }finally{
        setLoading(false);
      }
    }

    function renderTsChart(series){
      const ctx = document.getElementById('tsChart').getContext('2d');

      const labels   = series.map(r => r.date);
      const bookings = series.map(r => r.bookings);
      const revenue  = series.map(r => r.revenue);

      const cs          = getComputedStyle(document.documentElement);
      const accentDark  = (cs.getPropertyValue('--accent-dark') || '#D9AE00').trim();
      const lineMuted   = 'rgba(69, 71, 75, 0.70)';
      const areaFill    = 'rgba(244, 206, 20, 0.10)';

      if (tsChart){ tsChart.destroy(); }

      tsChart = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {
              label:'Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª',
              data:bookings,
              yAxisID:'y1',
              borderWidth:2,
              borderColor:accentDark,
              backgroundColor:areaFill,
              pointRadius:2.5,
              pointHoverRadius:4,
              tension:0.25,
              fill:true
            },
            {
              label:'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯',
              data:revenue,
              yAxisID:'y2',
              borderWidth:2,
              borderColor:lineMuted,
              backgroundColor:'transparent',
              pointRadius:2,
              pointHoverRadius:4,
              borderDash:[5,4],
              tension:0.25,
              fill:false
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{
              display:true,
              labels:{font:{size:11}}
            },
            tooltip:{mode:'index',intersect:false}
          },
          scales:{
            x:{ticks:{font:{size:10}}},
            y1:{
              beginAtZero:true,
              position:'left',
              ticks:{font:{size:10}}
            },
            y2:{
              beginAtZero:true,
              position:'right',
              grid:{drawOnChartArea:false},
              ticks:{font:{size:10}}
            }
          }
        }
      });
    }

    function renderRatingChart(dist){
      const ctx = document.getElementById('ratingChart').getContext('2d');
      const labels = ['â˜…1','â˜…2','â˜…3','â˜…4','â˜…5'];

      const cs         = getComputedStyle(document.documentElement);
      const accent     = (cs.getPropertyValue('--accent') || '#F4CE14').trim();
      const accentDark = (cs.getPropertyValue('--accent-dark') || '#D9AE00').trim();

      if (ratingChart){ ratingChart.destroy(); }

      ratingChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª',
            data:dist,
            borderWidth:1,
            borderColor:accentDark,
            backgroundColor:accent,
            hoverBackgroundColor:accentDark,
            hoverBorderColor:accentDark
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{mode:'index',intersect:false}
          },
          scales:{
            x:{ticks:{font:{size:10}}},
            y:{beginAtZero:true,ticks:{font:{size:10}}}
          }
        }
      });
    }

    function renderLocationTable(rows){
      const body = document.getElementById('tblLocationBody');
      body.innerHTML = '';
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.';
        td.style.textAlign = 'center';
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Ø§Ù„Ù…ÙˆÙ‚Ø¹">${r.Key || 'â€”'}</td>
          <td data-label="Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">${formatNumber(r.Bookings)}</td>
          <td data-label="Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">${formatNumber(r.Revenue)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderServicesTable(rows){
      const body = document.getElementById('tblServicesBody');
      body.innerHTML = '';
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.';
        td.style.textAlign = 'center';
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Ø§Ù„Ø®Ø¯Ù…Ø©">${r.Key || 'â€”'}</td>
          <td data-label="Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª">${formatNumber(r.Bookings)}</td>
          <td data-label="Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯">${formatNumber(r.Revenue)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderBookingsList(list){
      const el = document.getElementById('listBookings');
      el.innerHTML = '';
      if (!list.length){
        el.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.';
        return;
      }
      list.slice(0,50).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'list-item';
        const date = item.dateISO || '';
        const time = item.time || '';
        const name = item.customerName || 'Ø¹Ù…ÙŠÙ„';
        const service = item.serviceAR || 'â€”';
        const loc = item.location || 'â€”';
        const rev = formatNumber(item.revenue);
        div.innerHTML = `
          <div class="list-title">
            <span class="list-pill">${service}</span>
            ${name}
          </div>
          <div class="list-meta">
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date} â€¢ Ø§Ù„ÙˆÙ‚Øª: ${time || 'â€”'} â€¢ Ø§Ù„ÙØ±Ø¹: ${loc} â€¢ Ø§Ù„Ù‚ÙŠÙ…Ø©: ${rev}
          </div>
        `;
        el.appendChild(div);
      });
    }

    function renderReviewsList(list){
      const el = document.getElementById('listReviews');
      el.innerHTML = '';
      if (!list.length){
        el.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.';
        return;
      }
      list.slice(0,50).forEach(item=>{
        const div = document.createElement('div');
        div.className = 'list-item';
        const date = item.dateISO || '';
        const time = item.time || '';
        const name = item.customerName || 'Ø¹Ù…ÙŠÙ„';
        const rating = Number(item.rating)||0;
        const nps = (item.nps!==null && item.nps!==undefined && item.nps!=='') ? ` â€¢ NPS: ${item.nps}` : '';
        const text = item.text || '';
        div.innerHTML = `
          <div class="list-title">
            â­ ${rating.toFixed(1)} â€¢ ${name}
          </div>
          <div class="list-meta">
            ${date} ${time || ''}${nps}
          </div>
          <div style="margin-top:2px;">${text}</div>
        `;
        el.appendChild(div);
      });
    }

    function clearFilters(){
      document.getElementById('filterLocation').value = '';
      document.getElementById('filterService').value = '';
      document.getElementById('filterLocale').value = '';
      setDefaultDates();

      const chips = document.querySelectorAll('#quickRanges .chip');
      chips.forEach(ch => ch.classList.remove('is-active'));
      const defaultChip = document.querySelector('#quickRanges .chip[data-range="30"]');
      if (defaultChip) defaultChip.classList.add('is-active');
    }

    /* ========== ANIMATION ON SCROLL ========== */
    function initScrollAnimations(){
      const observer = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if (entry.isIntersecting){
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      },{
        threshold:0.1
      });

      document.querySelectorAll('.anim-section').forEach(el=>{
        observer.observe(el);
      });
    }

    function init(){
      initTheme();
      setDefaultDates();
      setQuickRange('30');

      loadFilters();
      loadDashboard();
      initScrollAnimations();

      document.getElementById('btnApply').addEventListener('click', loadDashboard);
      document.getElementById('btnClear').addEventListener('click', ()=>{
        clearFilters();
        loadDashboard();
      });
      document.getElementById('btnRefresh').addEventListener('click', ()=>{
        loadFilters();
        loadDashboard();
      });
      document.getElementById('btnTheme').addEventListener('click', ()=>{
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
      });

      const chips = document.querySelectorAll('#quickRanges .chip');
      chips.forEach(chip=>{
        chip.addEventListener('click', ()=>{
          chips.forEach(c=>c.classList.remove('is-active'));
          chip.classList.add('is-active');
          const range = chip.getAttribute('data-range');
          setQuickRange(range);
          loadDashboard();
        });
      });

      const filterInputs = [
        document.getElementById('dateFrom'),
        document.getElementById('dateTo'),
        document.getElementById('filterLocation'),
        document.getElementById('filterService'),
        document.getElementById('filterLocale')
      ].filter(Boolean);

      filterInputs.forEach(el=>{
        el.addEventListener('keydown', e=>{
          if (e.key === 'Enter'){
            e.preventDefault();
            loadDashboard();
          }
        });
      });
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
